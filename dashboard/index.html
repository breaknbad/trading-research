<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Trading Competition Dashboard</title>
<style>
  :root {
    --bg: #0d1117;
    --surface: #161b22;
    --surface2: #1c2333;
    --border: #30363d;
    --text: #e6edf3;
    --text2: #8b949e;
    --green: #3fb950;
    --red: #f85149;
    --blue: #58a6ff;
    --purple: #bc8cff;
    --yellow: #d29922;
    --orange: #f0883e;
  }
  * { margin: 0; padding: 0; box-sizing: border-box; }
  body { background: var(--bg); color: var(--text); font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Helvetica, Arial, sans-serif; line-height: 1.5; }
  .container { max-width: 1400px; margin: 0 auto; padding: 20px; }

  /* Header */
  header { display: flex; justify-content: space-between; align-items: center; padding: 24px 0; border-bottom: 1px solid var(--border); margin-bottom: 24px; }
  header h1 { font-size: 24px; font-weight: 700; }
  header h1 span { color: var(--blue); }
  .status { display: flex; align-items: center; gap: 8px; color: var(--text2); font-size: 13px; }
  .status-dot { width: 8px; height: 8px; border-radius: 50%; background: var(--green); animation: pulse 2s infinite; }
  @keyframes pulse { 0%, 100% { opacity: 1; } 50% { opacity: 0.4; } }

  /* Tabs */
  .tabs { display: flex; gap: 4px; margin-bottom: 24px; border-bottom: 1px solid var(--border); }
  .tab { padding: 10px 20px; background: none; border: none; color: var(--text2); font-size: 14px; cursor: pointer; border-bottom: 2px solid transparent; transition: all 0.2s; }
  .tab:hover { color: var(--text); }
  .tab.active { color: var(--text); border-bottom-color: var(--blue); }
  .section { display: none; }
  .section.active { display: block; }

  /* Leaderboard */
  .leaderboard { width: 100%; border-collapse: collapse; }
  .leaderboard th { text-align: left; padding: 12px 16px; color: var(--text2); font-size: 12px; text-transform: uppercase; letter-spacing: 0.5px; border-bottom: 1px solid var(--border); }
  .leaderboard td { padding: 16px; border-bottom: 1px solid var(--border); }
  .leaderboard tr:hover td { background: var(--surface2); }
  .rank { font-size: 20px; font-weight: 700; color: var(--text2); width: 40px; }
  .rank-1 { color: var(--yellow); }
  .rank-2 { color: #aaa; }
  .rank-3 { color: #cd7f32; }
  .bot-name { display: flex; align-items: center; gap: 10px; }
  .bot-emoji { font-size: 24px; }
  .bot-label { font-weight: 600; }
  .bot-strategy { color: var(--text2); font-size: 12px; max-width: 250px; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
  .positive { color: var(--green); }
  .negative { color: var(--red); }
  .mono { font-family: 'SF Mono', SFMono-Regular, ui-monospace, Menlo, monospace; font-size: 14px; }

  /* Cards */
  .cards { display: grid; grid-template-columns: repeat(auto-fit, minmax(340px, 1fr)); gap: 16px; }
  .card { background: var(--surface); border: 1px solid var(--border); border-radius: 12px; overflow: hidden; }
  .card-header { display: flex; justify-content: space-between; align-items: center; padding: 16px 20px; cursor: pointer; user-select: none; }
  .card-header:hover { background: var(--surface2); }
  .card-header h3 { display: flex; align-items: center; gap: 8px; font-size: 16px; }
  .card-toggle { color: var(--text2); font-size: 18px; transition: transform 0.2s; }
  .card.open .card-toggle { transform: rotate(180deg); }
  .card-body { display: none; padding: 0 20px 20px; }
  .card.open .card-body { display: block; }
  .stat-row { display: flex; justify-content: space-between; padding: 8px 0; border-bottom: 1px solid var(--border); }
  .stat-row:last-child { border: none; }
  .stat-label { color: var(--text2); font-size: 13px; }
  .stat-value { font-weight: 600; font-size: 14px; }

  /* Positions table */
  .pos-table { width: 100%; border-collapse: collapse; margin-top: 12px; font-size: 13px; }
  .pos-table th { text-align: left; padding: 8px; color: var(--text2); font-size: 11px; text-transform: uppercase; border-bottom: 1px solid var(--border); }
  .pos-table td { padding: 8px; border-bottom: 1px solid var(--border); }
  .badge { display: inline-block; padding: 2px 8px; border-radius: 4px; font-size: 11px; font-weight: 600; text-transform: uppercase; }
  .badge-long { background: rgba(63,185,80,0.15); color: var(--green); }
  .badge-short { background: rgba(248,81,73,0.15); color: var(--red); }
  .badge-tag { background: rgba(88,166,255,0.15); color: var(--blue); }

  /* Trade log */
  .trade-log { width: 100%; border-collapse: collapse; }
  .trade-log th { text-align: left; padding: 12px; color: var(--text2); font-size: 12px; text-transform: uppercase; letter-spacing: 0.5px; border-bottom: 1px solid var(--border); cursor: pointer; }
  .trade-log th:hover { color: var(--text); }
  .trade-log td { padding: 12px; border-bottom: 1px solid var(--border); font-size: 13px; }
  .trade-log tr:hover td { background: var(--surface2); }
  .action-buy { color: var(--green); font-weight: 600; }
  .action-sell { color: var(--red); font-weight: 600; }
  .reason-text { max-width: 300px; color: var(--text2); font-size: 12px; }

  /* Review cards */
  .review-card { background: var(--surface); border: 1px solid var(--border); border-radius: 12px; padding: 20px; margin-bottom: 16px; }
  .review-card h3 { display: flex; align-items: center; gap: 8px; margin-bottom: 16px; font-size: 16px; }
  .review-section { margin-bottom: 16px; }
  .review-section h4 { color: var(--text2); font-size: 12px; text-transform: uppercase; letter-spacing: 0.5px; margin-bottom: 8px; display: flex; align-items: center; gap: 6px; }
  .review-section ul { list-style: none; padding: 0; }
  .review-section li { padding: 6px 0 6px 16px; position: relative; color: var(--text); font-size: 13px; }
  .review-section li::before { content: ''; position: absolute; left: 0; top: 12px; width: 6px; height: 6px; border-radius: 50%; }
  .mistakes li::before { background: var(--red); }
  .lessons li::before { background: var(--green); }
  .evolution { color: var(--text2); font-size: 13px; padding: 12px; background: var(--surface2); border-radius: 8px; border-left: 3px solid var(--purple); }

  /* Strategy */
  .strategy-card { background: var(--surface); border: 1px solid var(--border); border-radius: 12px; padding: 24px; margin-bottom: 16px; }
  .strategy-card h3 { display: flex; align-items: center; gap: 8px; margin-bottom: 8px; }
  .strategy-card p { color: var(--text2); font-size: 14px; line-height: 1.6; }
  .strategy-tags { display: flex; gap: 6px; margin-top: 12px; flex-wrap: wrap; }

  /* Responsive */
  @media (max-width: 768px) {
    .cards { grid-template-columns: 1fr; }
    .leaderboard, .trade-log { font-size: 12px; }
    .leaderboard td, .leaderboard th, .trade-log td, .trade-log th { padding: 8px; }
    .container { padding: 12px; }
    .tabs { overflow-x: auto; }
  }
</style>
</head>
<body>
<div class="container">
  <header>
    <h1>üìä Trading <span>Competition</span></h1>
    <div class="status">
      <div class="status-dot"></div>
      <span id="last-update">Loading...</span>
    </div>
  </header>

  <div class="tabs">
    <button class="tab active" data-tab="leaderboard">üèÜ Leaderboard</button>
    <button class="tab" data-tab="portfolios">üíº Portfolios</button>
    <button class="tab" data-tab="trades">üìã Trade Log</button>
    <button class="tab" data-tab="review">üìù Daily Review</button>
    <button class="tab" data-tab="strategy">üß† Strategies</button>
  </div>

  <div id="leaderboard" class="section active"></div>
  <div id="portfolios" class="section"></div>
  <div id="trades" class="section"></div>
  <div id="review" class="section"></div>
  <div id="strategy" class="section"></div>
</div>

<script>
const BOT_FILES = ['alfred', 'vex', 'tars', 'eddie'];
let allData = [];

function fmt(n) { return n.toLocaleString('en-US', { minimumFractionDigits: 2, maximumFractionDigits: 2 }); }
function pnlClass(n) { return n >= 0 ? 'positive' : 'negative'; }
function pnlSign(n) { return n >= 0 ? '+' : ''; }
function fmtTime(ts) {
  const d = new Date(ts);
  return d.toLocaleDateString('en-US', { month: 'short', day: 'numeric' }) + ' ' +
         d.toLocaleTimeString('en-US', { hour: '2-digit', minute: '2-digit' });
}

async function loadData() {
  const results = await Promise.all(BOT_FILES.map(async f => {
    try {
      const r = await fetch(`data/${f}.json?t=${Date.now()}`);
      return await r.json();
    } catch(e) { console.error(`Failed to load ${f}:`, e); return null; }
  }));
  allData = results.filter(Boolean);
  render();
}

function render() {
  renderLeaderboard();
  renderPortfolios();
  renderTrades();
  renderReview();
  renderStrategy();
  const latest = allData.reduce((a, b) => new Date(a.timestamp) > new Date(b.timestamp) ? a : b);
  document.getElementById('last-update').textContent = `Updated ${fmtTime(latest.timestamp)} ¬∑ Auto-refresh 30s`;
}

function renderLeaderboard() {
  const sorted = [...allData].sort((a, b) => b.portfolio.total_return_pct - a.portfolio.total_return_pct);
  let html = `<table class="leaderboard"><thead><tr>
    <th>#</th><th>Bot</th><th>Total Value</th><th>Daily P&L</th><th>Total Return</th>
  </tr></thead><tbody>`;
  sorted.forEach((d, i) => {
    const p = d.portfolio;
    html += `<tr>
      <td class="rank rank-${i+1}">${i+1}</td>
      <td><div class="bot-name"><span class="bot-emoji">${d.bot.emoji}</span><div><div class="bot-label">${d.bot.name}</div><div class="bot-strategy">${d.strategy}</div></div></div></td>
      <td class="mono">$${fmt(p.total_value)}</td>
      <td class="mono ${pnlClass(p.daily_pnl)}">${pnlSign(p.daily_pnl)}$${fmt(p.daily_pnl)}</td>
      <td class="mono ${pnlClass(p.total_return_pct)}">${pnlSign(p.total_return_pct)}${p.total_return_pct.toFixed(2)}%</td>
    </tr>`;
  });
  html += '</tbody></table>';
  document.getElementById('leaderboard').innerHTML = html;
}

function renderPortfolios() {
  let html = '<div class="cards">';
  allData.forEach(d => {
    const p = d.portfolio;
    html += `<div class="card open">
      <div class="card-header" onclick="this.parentElement.classList.toggle('open')">
        <h3><span>${d.bot.emoji}</span> ${d.bot.name}</h3>
        <span class="card-toggle">‚ñº</span>
      </div>
      <div class="card-body">
        <div class="stat-row"><span class="stat-label">Total Value</span><span class="stat-value mono">$${fmt(p.total_value)}</span></div>
        <div class="stat-row"><span class="stat-label">Cash</span><span class="stat-value mono">$${fmt(p.cash)}</span></div>
        <div class="stat-row"><span class="stat-label">Realized P&L</span><span class="stat-value mono ${pnlClass(p.realized_pnl)}">${pnlSign(p.realized_pnl)}$${fmt(p.realized_pnl)}</span></div>
        <div class="stat-row"><span class="stat-label">Unrealized P&L</span><span class="stat-value mono ${pnlClass(p.unrealized_pnl)}">${pnlSign(p.unrealized_pnl)}$${fmt(p.unrealized_pnl)}</span></div>
        <div class="stat-row"><span class="stat-label">Total Return</span><span class="stat-value mono ${pnlClass(p.total_return_pct)}">${pnlSign(p.total_return_pct)}${p.total_return_pct.toFixed(2)}%</span></div>
        ${p.positions.length ? `<table class="pos-table"><thead><tr><th>Ticker</th><th>Side</th><th>Shares</th><th>Entry</th><th>Current</th><th>P&L</th></tr></thead><tbody>
        ${p.positions.map(pos => {
          const pnl = (pos.current_price - pos.entry_price) * pos.shares * (pos.side === 'short' ? -1 : 1);
          return `<tr>
            <td><strong>${pos.ticker}</strong></td>
            <td><span class="badge badge-${pos.side}">${pos.side}</span></td>
            <td class="mono">${pos.shares}</td>
            <td class="mono">$${fmt(pos.entry_price)}</td>
            <td class="mono">$${fmt(pos.current_price)}</td>
            <td class="mono ${pnlClass(pnl)}">${pnlSign(pnl)}$${fmt(pnl)}</td>
          </tr>`;
        }).join('')}
        </tbody></table>` : '<p style="color:var(--text2);font-size:13px;margin-top:12px;">No open positions</p>'}
      </div>
    </div>`;
  });
  html += '</div>';
  document.getElementById('portfolios').innerHTML = html;
}

function renderTrades() {
  const all = [];
  allData.forEach(d => d.trades.forEach(t => all.push({ ...t, bot: d.bot })));
  all.sort((a, b) => new Date(b.timestamp) - new Date(a.timestamp));
  let html = `<table class="trade-log"><thead><tr>
    <th>Time</th><th>Bot</th><th>Action</th><th>Ticker</th><th>Shares</th><th>Price</th><th>Strategy</th><th>Reason</th>
  </tr></thead><tbody>`;
  all.forEach(t => {
    const actionClass = ['buy','cover'].includes(t.action) ? 'action-buy' : 'action-sell';
    html += `<tr>
      <td class="mono">${fmtTime(t.timestamp)}</td>
      <td>${t.bot.emoji} ${t.bot.name}</td>
      <td class="${actionClass}">${t.action.toUpperCase()}</td>
      <td><strong>${t.ticker}</strong></td>
      <td class="mono">${t.shares}</td>
      <td class="mono">$${fmt(t.price)}</td>
      <td><span class="badge badge-tag">${t.strategy_tag}</span></td>
      <td class="reason-text">${t.reason}</td>
    </tr>`;
  });
  html += '</tbody></table>';
  document.getElementById('trades').innerHTML = html;
}

function renderReview() {
  let html = '';
  allData.forEach(d => {
    const r = d.daily_review;
    html += `<div class="review-card">
      <h3><span>${d.bot.emoji}</span> ${d.bot.name}</h3>
      <div class="review-section mistakes"><h4>‚ùå Mistakes</h4><ul>${r.mistakes.map(m => `<li>${m}</li>`).join('')}</ul></div>
      <div class="review-section lessons"><h4>‚úÖ Lessons</h4><ul>${r.lessons.map(l => `<li>${l}</li>`).join('')}</ul></div>
      <div class="review-section"><h4>üîÑ Strategy Evolution</h4><div class="evolution">${r.strategy_evolution}</div></div>
    </div>`;
  });
  document.getElementById('review').innerHTML = html;
}

function renderStrategy() {
  let html = '';
  allData.forEach(d => {
    const tags = new Set();
    d.trades.forEach(t => tags.add(t.strategy_tag));
    d.portfolio.positions.forEach(p => tags.add(p.strategy_tag));
    html += `<div class="strategy-card">
      <h3><span>${d.bot.emoji}</span> ${d.bot.name}</h3>
      <p>${d.strategy}</p>
      <div class="strategy-tags">${[...tags].map(t => `<span class="badge badge-tag">${t}</span>`).join('')}</div>
    </div>`;
  });
  document.getElementById('strategy').innerHTML = html;
}

// Tab switching
document.querySelectorAll('.tab').forEach(tab => {
  tab.addEventListener('click', () => {
    document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
    document.querySelectorAll('.section').forEach(s => s.classList.remove('active'));
    tab.classList.add('active');
    document.getElementById(tab.dataset.tab).classList.add('active');
  });
});

// Load and auto-refresh
loadData();
setInterval(loadData, 30000);
</script>
</body>
</html>
